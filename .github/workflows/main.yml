name: Deploy

# Controls when the action will run. 
on:
  # Triggers the workflow on push or pull request events but only for the master branch
  push:
    branches: [ main ]

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
    - name: Deploy using ssh
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_KEY }}
        port: 22
        script: |
          DOCKER_PASSWORD=${{ secrets.DOCKER_PASSWORD }}
          DOCKER_LOGIN=${{ secrets.DOCKER_LOGIN }}
          DOCKER_REGISTRY=${{ secrets.DOCKER_REGISTRY }}
          cd /var/www/taskwave.ru/html
          rm -rf taskwave
          git clone git@github.com:rtvsk/taskwave.git
          cd /var/www/taskwave.ru/html/taskwave/webrtc
          npm ci --verbose
          npm start
          # /var/www/taskwave.ru/html/taskwave/webrtc
          # git pull origin main
          # git status
          # cd client
          # rm -rf build
          # npm ci --verbose
          # npm run build
          # cd /var/www/
          # chmod +x copy_files.sh
          # ./copy_files.sh
          # cd /var/www/shaare/backend
          # echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_LOGIN" --password-stdin "$DOCKER_REGISTRY"
          # docker build -t "$DOCKER_LOGIN/shaare:latest" .
          # docker push "$DOCKER_LOGIN/shaare:latest"
          # docker stop $(docker ps -q) && docker rm $(docker ps -aq)
          # docker run -d -p 3333:3333 -v nodejs-images-data:/usr/src/app/images "$DOCKER_LOGIN/shaare:latest"